
# 스트리밍 정산  시스템

## 프로젝트 소개

- 스트리머(사용자)의 특정 스트리밍 동영상들에 대한 조회수 및 광고 시청 횟수를 특정 단가를 적용하여 
  수익을 정산해주는 시스템
  
- 주요 기능:
	- 동영상 시청 및 광고 시청 기능 제공
	- 조회수 어뷰징 방지 기능 적용
	- 동영상 조회수 및 누적 재생시간 일별, 주별, 월별 TOP5 랭킹 제공
	- 크리에이터 회원을 위한 수익 정산 제공

- ​개발 기간 - 2024.10.19 ~ 2024.11.21


<br><br><br>


## 프로젝트 개발 환경 및 기술 스택

- **언어**: Java 21
- **빌드 도구**: Gradle
- **프레임워크**: Spring Boot 3.3.4
- **라이브러리 및 기술 스택**: Spring Cloud, Spring Batch, Spring Data JPA, Spring Security
- **Database**: MySQL 8.0,  Redis
- **DevOps**: Docker, ELK Stack, Prometheus & Grafana


<br><br><br>

## 주요 기능 소개

- **스트리밍 동영상 시청 기능**
	- 광고 시청 기능 포함 - 동영상 재생 중 일정 시간마다 광고가 재생됩니다.
	- 조회수 어뷰징 방지 기능 적용 - IP 주소와 회원 정보를 기반으로 중복 조회를 방지하여 공정한 수익 분배 보장

- **조회수 및 누적 재생시간 TOP5 동영상 조회**
	- 일별, 주별, 월별로 상위 동영상 랭킹 제공

- **수익 정산 내역 조회**
	- Creator 회원 전용 기능 - 자신의 동영상에 대한 수익금 및 정산 내역을 기간별로 조회

- **회원가입 및 소셜 로그인 기능**
	- 일반 회원가입
	- 소셜 로그인 - 구글 로그인 제공

- **정산 및 통계 배치 작업**
	- 매일 정해진 시간에 자동으로 수익 정산 및 통계 데이터 생성


<br><br><br>

## 아키텍처 설계

### 서비스 아키텍처

![Blank board (2)](https://github.com/user-attachments/assets/c40196f9-175e-4112-91d6-0078496667ae)

1. 인프라 계층
   - Eureka Server: 마이크로서비스의 서비스 디스커버리를 위한 레지스트리 서버
   - Config Server: 중앙화된 구성 관리로 각 서비스의 설정 정보를 제공
   - API Gateway: 클라이언트의 요청을 각 마이크로 서비스로 라우팅하고, 인증 및 로드밸런싱을 수행

2. 서비스 계층
   - Member Service: 회원 서비스
   - Streaming Service: 스트리밍 및 광고 재생과 관련된 API를 제공하는 서비스
   - Settlement Service: 정산 및 통계데이터를 조회하는 API를 제공하는 서비스
   - Batch Server: 배치 작업을 통해 정산 및 통계 데이터 생성

3. 데이터 계층
   - Member DB - 회원 데이터 저장
   - Streaming DB - 스트리밍(동영상) 및 광고 데이터 저장
   - Settlement DB - 정산 및 통계 데이터 저장
   - Redis - 사용자 인증 토큰을 관리

<br><br>

### ERD 설계

![스트리밍 정산시스템 (3)](https://github.com/user-attachments/assets/e852bc7c-e360-447d-90ef-fa9e61df493e)

- **주요 테이블**
	- **Member**
		- 사용자 정보 관리
	- **Stremaing**
		- 동영상 정보 관리
	- **Advertisement / StreamingAdMapping**
		- 동영상에 삽입되는 광고 관리 / 스트리밍과 광고 연관관계의 다대다 매핑 테이블
	- **StreamingViewLog / AdViewLog**
		- 동영상 시청 이력 관리 / 광고 시청 이력 관리
	- **Settlement**
		- 수익 정산 정보 관리
	- **StatisticsSummary / TopStreamingStatistics**
		- 통계 요약 정보 관리 / 조회수 및 누적 재생시간 상위 동영상 정보 관리

<br><br><br>

## 핵심 기능 상세 설명

### Use Case
![정산시스템 유스케이스](https://github.com/user-attachments/assets/1888cfe9-6f8e-4c7b-8e1b-b7e3a9b5d611)


**공통 기능**
- **스트리밍 동영상 시청**
	- 광고 시청, 조회수 어뷰징 방지 등의 기능 포함

- **조회수 및 누적 재생시간 TOP5 동영상 조회**
	- 배치작업을 통해 생성된 통계 데이터를 조회

**회원 기능**
- **동영상 및 광고 수익 정산내역 조회**
	- 정산 배치작업을 통해 생성된 데이터를 사용자에게 제공
	- 수익 정산 조회 기능은 인증(가입)된 회원, 그 중에서도 권한이 Creator인 회원만 사용 가능

**비회원 기능**
- 회원가입 및 소셜로그인 기능

<br>

### 1. 동영상 수익 정산 배치 작업

![diagram-export-2024 -12 -4 -오후-5_52_03](https://github.com/user-attachments/assets/bad5bfea-96ca-4bfd-967d-646d302fca54)

매일 자정에 실행되는 **배치 작업을 통해 전날의 동영상 조회수 및 광고 시청 횟수를 기반으로 각 동영상의 수익을 정확하게 계산**하고 정산 정보를 업데이트 하도록 구현
1. **수익 단가 정보 캐싱**
	- 정산에 필요한 조회수 및 광고 시청 단가 정보를 데이터베이스에 한 번만 조회하도록하여 메모리에 캐싱

2. **배치 Job 구성**
	- 마스터 스텝을 시작으로 데이터 파티셔닝 및 멀티스레드 처리를 수행

3. **파티셔닝 및 멀티스레드 처리**
	- **마스터 스텝**
		- 스트리밍 테이블의 id 범위를 기준으로 데이터를 균등하게 분할
	- **워커 스텝**
		- 별도의 스레드에서 실행되는 각 파티션들은 스트리밍 데이터에 대한 읽기, 처리, 쓰기 작업을 수행

4. **데이터 처리 흐름**
	- **Reader**
		- 지정된 id 범위 내의 스트리밍 데이터를 DB에서 조회, 대용량 데이터 처리를 위해 페이징을 적용하여 메모리 사용 최적화
	- **Processor**
		- 동영상의 수익을 계산하고 정산 정보를 생성
		- 수익 계산 로직
			- **이전 정산 시점 이후의 조회수 및 광고 시청 횟수**를 대상으로 **구간별 단가**를 적용하여 수익을 계산
	- **Writer**
		- 처리된 정산 데이터를 DB에 저장하고, 해당 스트리밍 엔티티의 마지막 정산 정보를 업데이트

5. **수익 계산 로직 상세**

|        | 조회수 10만 미만 | 10만 이상 50만 미만 | 50만 이상 100만 미만 | 100만 이상 |
| :----: | :---------: | :-----------: | :------------: | :-----: |
| 동영상 단가 |     1원      |     1.1원      |      1.3원      |  1.5원   |
| 광고 단가  |     10원     |      12원      |      15원       |   20원   |

- 광고 영상은 영상의 길이 5분당 1개씩 등록
    - e.g. 5분 초과 영상의 경우 5분에 1개의 광고가 등록되며, 10분초과 영상에는 5분 ,10분에 한개씩 총 2개가 등록

- 수익계산 수식
	- 동영상별 정산금액 = 스트리밍 영상 정산 금액 + 광고 영상 정산 금액, 1원단위 이하 절사
		- 스트리밍 영상 정산 금액 = 영상별 단가 * 조회 수
		- 광고 영상 정산 금액 = 광고별 단가 * 광고 조회 수

- 영상 정산금액과 광고 정산금액은 누적되어 적용되며 정산은 1일단위로 진행
	- e.g. 1일차 조회수가 55만 2일차 조회수가 60만일 경우(누적 115만)
	    - 1일차는 99,999회 * 1원 + 400,000회 * 1.1원 + 50,001회 * 1.3원
	    - 2일차는 449,999(550,001 ~ 999,999) * 1.3원 + 150,001(1,000,000 ~ 1,150,000) * 1.5원

<br><br>

### 2. 조회수 및 누적 재생시간 TOP5 통계 배치 작업

![diagram-export-2024 -12 -4 -오후-6_03_35](https://github.com/user-attachments/assets/6ad90318-81f7-4ac8-90a2-1af7c31f64ec)

1. **배치 Job 구성**
	- 기간별 통계데이터를 생성하기 위해 daily, weekly, monthly로 3개의 잡으로 구성
	- 각 Job은 2개의 Step으로 구성
		- 조회수 상위 5개 동영상 선정
		- 누적 재생시간 상위 5개 동영상 선정
	- 각 Step은 Redaer, Processor, Writer로 구성

2. **데이터 처리 흐름**
	- **Reader**
		- JpaCursorItemReader를 사용하여 스트리밍 방식으로 데이터 조회
		- **쿼리 조건**
			- **조회수 TOP5**
				- 지정된 기간 내에서 조회수가 높은 순으로 상위 5개의 동영상 조회
				- 날짜 범위 설정
					- 일별 - 전날의 데이터 (LocalDate.now().minusDays(1))
					- 주별 - 지난 주의 데이터 (이전 주의 월요일부터 일요일까지)
					- 월별 - 지난 달의 데이터 (이전 달의 1일부터 말일까지)
			- **누적 재생시간 TOP5**
				- 동일한 날짜 범위 내에서 누적 재생시간이 긴 순으로 상위 5개의 동영상 조회

	- **Processor**
		- 랭킹 데이터 생성
			- 조회된 동영상에 랭킹을 부여하고 TopStreamingStatistics 객체로 변환
		- 통계 요약 정보 생성
			- 각 기간별로 통계 요약 정보를 담는 StatisticsSummary 엔티티를 생성

	- **Writer**
		- 처리된 데이터를 데이터베이스에 일괄 저장

3. 배치작업 스케줄링
	- 일별 배치: 매일 자정에 실행되어 전날의 데이터를 처리
	- 주별 배치: 매주 월요일에 실행되어 지난 주(월~일)의 데이터를 처리
	- 월별 배치: 매월 1일에 실행되어 지난 달의 데이터를 처리

<br>

### 3. 정산 및 통계 데이터 조회 API

![diagram-export-2024 -12 -4 -오후-7_22_05](https://github.com/user-attachments/assets/c4d9923e-3b66-4e16-8271-bc2c8893aadd)

- 정산 데이터 조회
	- 일별 정산 조회 - 특정 회원의 특정 날짜에 대한 정산 데이터를 제공
	- 주별 정산 조회 - 해당 주의 월요일부터 일요일까지의 정산 데이터를 제공
	- 월별 정산 조회 - 해당 월의 첫째 날부터 마지막 날까지의 정산 데이터를 제공
		- 기간 계산 로직
			- TemporalAdjusters와 YearMonth를 활용하여 일별, 주별, 월별 기간을 계산

- 통계 데이터 조회
	- 조회수와 재생 시간에 대한 상위 스트리밍 데이터를 제공
	- 마찬가지로 일별, 주별, 월별로 통계 데이터를 제공
	- 조회수와 재생 시간을 별도의 쿼리로 조회하여 각각의 랭킹 데이터를 가져옴
	- 하나의 쿼리로 모든 통계 데이터를 조회한 후, StatisticsType에 따라 그룹핑

<br>

### 4. 동영상 및 광고 관련 API

- **동영상 재생**
	- 30초 이내의 동일한 재생 요청이 들어오면 조회수 증가 X, 그게 아니라면 조회수 증가시키고 시청 기록 생성 및 업데이트
	- 광고 재생 처리를 위해 광고 서비스와 연동
- **동영상 일시정지**
	- 일시정지 시점의 재생 시간을 저장하여, 이후 재생 시 이어볼 수 있도록 엔티티 업데이트

- **어뷰징 방지**
	- 사용자의 IP로 30초 이내에 동일한 요청이 반복된다면 영상 조회수 및 광고 시청 횟수가 증가하지 않도록 처리
	- 동영상 업로더가 자신의 동영상을 재생하는 경우도 부정 행위로 간주

- 시청 기록 관리
	- 회원과 비회원 모두에 대한 시청 기록을 생성하고 관리
	- IP 주소와 회원 ID를 기준으로 시청 기록을 조회하고 업데이트

- 광고 재생
	- 동영상의 특정 재생 시점에 연동된 광고를 노출 (영상의 5분 간격마다 광고 노출)
	- 현재 재생 시간에 따라 노출되어야 할 광고를 결정
	- 광고 조회수를 증가시키고 광고 시청 기록을 생성
- **광고 매핑 관리**
	- 동영상과 광고의 매핑 정보를 관리하여, 동영상 재생 시점에 맞는 광고를 노출시킬 수 있도록 구현
- **광고 시청 기록 관리**
	- 회원과 비회원의 광고 시청 기록을 IP 주소와 회원 ID를 기준으로 관리


<br>

### 5. 회원 및 인증 관리


![스크린샷 2024-12-04 오후 9 58 28](https://github.com/user-attachments/assets/dc82945f-bbf9-44b2-8892-ca39d4e77cf9)


- **토큰 관리 전략**
	- JWT 기반 인증에서 **레디스 화이트리스트와 블랙리스트 전략**을 활용하여 보안을 강화
	- **화이트리스트** - 유효한 리프레쉬 토큰만 저장하여, 만료되거나 로그아웃 시 제거
	- **블랙리스트** - 사용된 액세스토큰을 무효화하여, 토큰 재발급이나 로그아웃 후 악용을 방지

- 로그인
	- **액세스토큰**이 생성되어 응답 바디로 반환
	- **리프레쉬토큰**은 Redis에 화이트리스트로 저장하고, TTL을 설정하여 유효기간이 지나면 자동 삭제
	- 리프레쉬토큰은 **HttpOnly 쿠키**로 클라이언트에 반환

- **토큰 재발급**
	- 액세스토큰 만료 시, 클라이언트는 리프레쉬토큰(쿠키)과 만료된 액세스토큰(헤더)으로 서버에 요청
	- 서버는 요청으로 받은 리프레쉬토큰이 화이트리스트에 저장된 토큰인지 확인하고 액세스토큰또한 블랙리스트에 없는지 확인
	- 검증 성공 시 기존 액세스토큰을 블랙리스트에 추가하고 새로운 액세스토큰 발급

- **로그아웃**
	- 사용자가 로그아웃 요청을 보내면 Redis 화이트리스트에서 리프레쉬토큰 삭제
	- 기존 액세스토큰을 블랙리스트에 추가하여 무효화
	- 쿠키에 저장된 리프레쉬토큰을 클라이언트에서 제거

<br><br><br>
  
## 기술적 의사결정

- **마이크로서비스 아키텍처 도입**
	- 서비스의 확장성과 유지보수성을 높이기 위해 선택
	- 서비스 간 결합도를 낮추고 독립적인 배포 및 스케일링이 가능하도록 설계

- **Spring Cloud**
	- **Eureka를 통한 서비스 디스커버리**
		- 동적으로 변하는 서비스 인스턴스를 효율적으로 관리하고자 선택
		- 각 서비스가 Eureka 서버에 등록하고 필요한 서비스의 위치를 실시간으로 조회하도록 구현

	- **Config Server를 통한 중앙 집중식 설정 관리**
		- 환경별 설정을 중앙에서 일관되게 관리하여 설정 오류를 줄이고자 선택
		- 모든 서비스의 설정 정보를 Config Server에 통합하여 변경 사항이 자동으로 반영되도록 구성

	- **API Gateway 도입**
		- 인증 및 인가를 중앙에서 처리하고 클라이언트와 서비스 간 통신을 효율적으로 관리하고자 선택
		- API Gateway에서 인증 로직을 처리하고 내부 서비스로의 요청을 라우팅

- **Spring Batch**
	- 대량의 데이터를 효율적으로 처리하기 위해 선택
	- 멀티스레드와 파티셔닝 기법을 적용하여 배치 작업의 처리 속도를 높이고 성능을 최적화

- **Redis**
	- 토큰의 유효성을 실시간으로 검증하고 로그아웃 시 토큰을 즉시 무효화하기 위해 Redis를 선택
	- Redis에 JWT의 화이트리스트와 블랙리스트를 저장, 인증 과정에서 해당 리스트를 조회하여 토큰의 유효성을 빠르게 검증

- **ELK Stack**
	- 여러 마이크로서비스의 로그 중앙집중 관리 및 효율적 조회 및 분석 필요성에 따라 도입
	- Logstash로 로그 수집 및 필터링, Elasticsearch로 인덱싱 및 검색, Kibana로 시각화 구축

- Prometheus & Grafana
	- 성능 병목지점을 찾아 개선하기 위해 도입
	- Prometheus로 메트릭 수집 및 저장, Grafana 대시보드로 지표 시각화

<br><br><br>

## 성능 개선

#### 정산 배치작업 성능 최적화

- 측정 도구: **Prometheus, Grafana, Micrometer**
- 처리량: 스트리밍 동영상 **전체 1억건 데이터중 필터링을 거친 1000만 건의 데이터로 측정**
	- 처리 대상(필터링 조건):
		- 동영상이 첫 정산 대상이라면:
			- 동영상의 조회수 1000회 혹은 광고 시청 횟수 500회 이상
		- 기존에 정산 되었던 동영상이라면:
			- 가장 최근에 정산했을 당시의 영상 조회수와 광고 시청 횟수를 현재와 비교 
			  (즉, 조회수 변동이 있을 경우에만 처리)
			  
- 최종 개선율: 약 **98% 향상**, 처리시간 **76시간에서 1시간 20분으로 단축**

##### 성능 개선 추이

| 단계        | **데이터 규모** | TPS         | 분당 처리 건수    | 아이템 당 평균 처리 시간 | **작업 완료 소요시간** | **개선율**       |
| --------- | ---------- | ----------- | ----------- | -------------- | -------------- | ------------- |
| **개선 전**  | 1천만 건      | 36.4 ops/s  | 2.18K ops/m | 28.3 ms        | 76시간           | -             |
| **1차 개선** | 1천만 건      | 727 ops/s   | 43.6K ops/m | 1.73 ms        | 3시간 49분        | 95% ↓         |
| **2차 개선** | 1천만 건      | 1.21K ops/s | 72.4K ops/m | 0.972 ms       | 2시간 18분        | 40% ↓ (1차 대비) |
| **3차 개선** | 1천만 건      | 2.09K ops/s | 125K ops/m  | 0.471 ms       | 1시간 20분        | 42% ↓ (2차 대비) |

<details>
<summary>성능측정 이미지</summary>
<div>
  
### 개선 전  
  
![image](https://github.com/user-attachments/assets/036dab70-31f4-4c30-ba3c-0666819ec9b1)  
![image](https://github.com/user-attachments/assets/2e8f483b-d24d-4f13-ac89-6e7a3f681f92)
![image](https://github.com/user-attachments/assets/d1e0c243-8ee7-4cf6-96fb-3ad386402ec0)

<br><br>
### 1차 개선
![image](https://github.com/user-attachments/assets/dbcad57d-cd0f-4eef-af53-9c00f88c23d0)
![image](https://github.com/user-attachments/assets/5fe81590-94a1-467c-a72c-1b48af4f351e)
![image](https://github.com/user-attachments/assets/a525754f-e009-4cd2-9b70-48c7cacd66b6)

<br><br>

### 2차 개선
![image](https://github.com/user-attachments/assets/84b59339-b4e5-445b-ae69-620ac3fe6e2d)
![image](https://github.com/user-attachments/assets/bd6df850-fee4-42a3-8d84-0370322035a2)
![image](https://github.com/user-attachments/assets/7d64f2c0-a5dd-4f09-bef8-dd8c89d9c553)

<br><br>

### 3차 개선
![image](https://github.com/user-attachments/assets/6bd9e756-0c10-4aa9-b744-e9429e8d3121)
![image](https://github.com/user-attachments/assets/b3665f30-b1ac-4922-bdf1-d245fcad50ac)
![image](https://github.com/user-attachments/assets/946edf03-aad8-4f9d-b128-03a6c36eaacb)


</div>
</details>


##### 주요 개선 사항
- 1차 개선:  Chunk 사이즈 최적화, 파티셔닝 활용 멀티스레드 처리
- 2차 개선: 인덱스 조회, 업데이트 쿼리 벌크 연산 적용
- 3차 개선: 파티션 인덱스 최적화, 배치 인서트 및 업데이트 최적화


<br><br><br>

## 트러블 슈팅

#### 동시성 이슈로 인해 데드락 발생

- 발생 원인
	- 여러 사용자가 동시에 동일한 동영상을 시청할 때, 각 요청이 동일한 Streaming 엔티티를 수정하고 저장하려고 시도하면서 데이터베이스에서 략 경합이 발생

- 해결 방법
	- JPA의 변경감지로 엔티티를 업데이트하는 방식에서, 데이터베이스 레벨에서의 원자적 업데이트 쿼리를 사용하기로 결정
```java
@Modifying
@Transactional
@Query("UPDATE Streaming s SET s.views = s.views + 1 WHERE s.id = :streamingId")
```
	
- 결과
	- 100번의 동시 요청에서도 데드락 현상이 발생하지 않고 안정적으로 동영상 조회수와 광고 조회수가 증가

<br><br><br>

## 운영 및 모니터링

- **로그 관리**
	- **ELK Stack**을활용하여 각 서비스의 로그를 중앙에서 수집하고 관리
	- Kibana 대시보드를 통해 로그 데이터 시각화

- **모니터링**
	•	Prometheus를 이용하여 시스템 메트릭과 애플리케이션 지표를 수집
	•	Grafana를 통해 시각화된 대시보드를 구성하여 서버 상태를 한눈에 파악



